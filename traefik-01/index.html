<!DOCTYPE html>
<html lang="en">
 <head>
  <meta charset="utf-8"/>
  <meta content="width=device-width" name="viewport"/>
  <link href="/bitmoji.ico" rel="icon" type="image/png"/>
  <link href="https://pype.dev/traefik-01/amp/" rel="amphtml"/>
  <meta content="$ilp.uphold.com/MGN2ni2YMXaQ" name="monetization" property="monetization"/>
  <!-- <link rel='stylesheet' href='/fonts.css' />
  <link rel='stylesheet' href='/archive-styles.css' />
  <link rel='stylesheet' href='/article.css' /> -->
  <link href="/main.css" rel="stylesheet"/>
  <link as="style" href="/one-dark.min.css" onload="this.onload=null;this.rel='stylesheet'" rel="preload"/>
  <link as="style" href="/furo-purge.min.css" onload="this.onload=null;this.rel='stylesheet'" rel="preload"/>
  <!-- <link rel="preload" href="/scroll.css" as="style" onload="this.onload=null;this.rel='stylesheet'"> -->
  <noscript>
   <!-- <link rel='stylesheet' href='/scroll.css' /> -->
   <link href="/one-dark.min.css" rel="stylesheet"/>
   <link href="/furo-purge.min.css" rel="stylesheet"/>
  </noscript>
  <link href="bitmoji_48x48.png" rel="apple-touch-icon" sizes="48x48"/>
  <link href="bitmoji_72x72.png" rel="apple-touch-icon" sizes="72x72"/>
  <link href="bitmoji_96x96.png" rel="apple-touch-icon" sizes="96x96"/>
  <link href="bitmoji_144x144.png" rel="apple-touch-icon" sizes="144x144"/>
  <link href="bitmoji_192x192.png" rel="apple-touch-icon" sizes="192x192"/>
  <link href="bitmoji_256x256.png" rel="apple-touch-icon" sizes="256x256"/>
  <link href="bitmoji_384x384.png" rel="apple-touch-icon" sizes="384x384"/>
  <link href="bitmoji_512x512.png" rel="apple-touch-icon" sizes="512x512"/>
  <title>
   Traefik-01
  </title>
  <meta content="article" name="og:type" property="og:type"/>
  <meta content="Nicholas Payne" name="og:author" property="og:author"/>
  <meta content="Nicholas Payne" name="og:site_name" property="og:site_name"/>
  <meta content="#3A5895" name="theme-color"/>
  <meta content="Nicholas Payne" name="og:author" property="og:author"/>
  <meta content="pypeaday@pm.me" name="og:author_email" property="og:author_email"/>
  <meta content="website" name="og:type" property="og:type"/>
  <meta content="If you don I like Traefik a lot because once I get some basic config up it In 2022 I A simple docker-compose file for traefik might look like this: I use Ansibl" name="description" property="description"/>
  <meta content="If you don I like Traefik a lot because once I get some basic config up it In 2022 I A simple docker-compose file for traefik might look like this: I use Ansibl" name="og:description" property="og:description"/>
  <meta content="If you don I like Traefik a lot because once I get some basic config up it In 2022 I A simple docker-compose file for traefik might look like this: I use Ansibl" name="twitter:description" property="twitter:description"/>
  <meta content="Traefik-01 | Pypeaday" name="og:title" property="og:title"/>
  <meta content="Traefik-01 | Pypeaday" name="twitter:title" property="twitter:title"/>
  <meta content="/static/images/traefik-01-og.png" name="og:image" property="og:image"/>
  <meta content="/static/images/traefik-01-og.png" name="twitter:image" property="twitter:image"/>
  <meta content="1600" name="og:image:width" property="og:image:width"/>
  <meta content="900" name="og:image:width" property="og:image:width"/>
  <meta content="summary_large_image" name="twitter:card" property="twitter:card"/>
  <meta content="Pypeaday" name="og:site_name" property="og:site_name"/>
  <meta content="@pypeaday" name="twitter:creator" property="twitter:creator"/>
  <meta content="Traefik-01" name="title" property="title"/>
  <meta content="markata 0.2.0" name="generator" property="generator"/>
  <link href="https://pype.dev/traefik-01/" rel="canonical"/>
  <meta content="https://pype.dev/traefik-01/" name="og:url" property="og:url"/>
  <link href="/manifest.json" rel="manifest"/>
  <meta content="/static/images/traefik-01-og_250x140.png" name="og:sm_image" property="og:sm_image"/>
  <meta content="/static/images/traefik-01-og_250x140.png" name="og:sm_image" property="og:sm_image"/>
 </head>
 <body>
  <nav>
   <ul>
    <li>
     <a href="/">
      Home
     </a>
    </li>
    <li>
     <a href="/archive/">
      Archive
     </a>
    </li>
    <li>
     <a aria-label="RSS" href="/rss.xml">
      <svg class="icon" height="16" viewbox="0 0 24 24" width="16" xmlns="http://www.w3.org/2000/svg">
       <path d="M 4 4.44 v 2.83 c 7.03 0 12.73 5.7 12.73 12.73 h 2.83 c 0 -8.59 -6.97 -15.56 -15.56 -15.56 Z m 0 5.66 v 2.83 c 3.9 0 7.07 3.17 7.07 7.07 h 2.83 c 0 -5.47 -4.43 -9.9 -9.9 -9.9 Z M 6.18 15.64 A 2.18 2.18 0 0 1 6.18 20 A 2.18 2.18 0 0 1 6.18 15.64" fill="currentColor">
       </path>
      </svg>
     </a>
    </li>
   </ul>
  </nav>
  <article class="blog-post h-entry">
   <!-- <div id='cover-wrapper'>
      <img src='/traefik-01.webp' alt='cover image for article' />
    </div> -->
   <div id="title-wrapper">
    <a class="u-url" href="https://pype.dev/traefik-01/">
     <h1 class="flair" id="title" style="text-align:right;z-index:2;padding-right:.2rem">
      Traefik-01
     </h1>
    </a>
    <p>
     <time class="dt-published post-date" datetime="2022-03-06" style="text-align:right;z-index:2">
      2022-03-06
     </time>
    </p>
    <div class="h-card p-author" rel="author">
     <div class="content">
      <a class="p-name u-url" href="https://pype.dev/">
       <p>
        <span class="p-given-name">
         Nicholas
        </span>
        <span class="p-family-name">
         Payne
        </span>
       </p>
      </a>
      <p class="p-note">
       Goofing off
       <a href="https://twitter.com/pypeaday">
        @pypeaday
       </a>
      </p>
     </div>
    </div>
    <!-- edit -->
    <p>
     <a alt="edit post url" href="https://github.com/nicpayne713/mental-data-lake/edit/main/pages/blog/traefik-01.md" title="edit this post">
      edit
      <span aria-label="" role="img">
       ✏️
      </span>
     </a>
    </p>
   </div>
   <!-- <h2 class='toc'>toc</h2> -->
   <!-- <div class="toc">
<ul>
<li><a href="#abcmeta">ABCMeta</a></li>
</ul>
</div>
 -->
   <div id="post-body">
    <h1 id="traefik">
     Traefik
     <a alt="id" class="heading-permalink" href="#traefik" title="link to #traefik">
      <span class="visually-hidden">
      </span>
      <svg aria-hidden="true" fill="currentColor" focusable="false" height="1em" viewbox="0 0 24 24" width="1em" xmlns="http://www.w3.org/2000/svg">
       <path d="M9.199 13.599a5.99 5.99 0 0 0 3.949 2.345 5.987 5.987 0 0 0 5.105-1.702l2.995-2.994a5.992 5.992 0 0 0 1.695-4.285 5.976 5.976 0 0 0-1.831-4.211 5.99 5.99 0 0 0-6.431-1.242 6.003 6.003 0 0 0-1.905 1.24l-1.731 1.721a.999.999 0 1 0 1.41 1.418l1.709-1.699a3.985 3.985 0 0 1 2.761-1.123 3.975 3.975 0 0 1 2.799 1.122 3.997 3.997 0 0 1 .111 5.644l-3.005 3.006a3.982 3.982 0 0 1-3.395 1.126 3.987 3.987 0 0 1-2.632-1.563A1 1 0 0 0 9.201 13.6zm5.602-3.198a5.99 5.99 0 0 0-3.949-2.345 5.987 5.987 0 0 0-5.105 1.702l-2.995 2.994a5.992 5.992 0 0 0-1.695 4.285 5.976 5.976 0 0 0 1.831 4.211 5.99 5.99 0 0 0 6.431 1.242 6.003 6.003 0 0 0 1.905-1.24l1.723-1.723a.999.999 0 1 0-1.414-1.414L9.836 19.81a3.985 3.985 0 0 1-2.761 1.123 3.975 3.975 0 0 1-2.799-1.122 3.997 3.997 0 0 1-.111-5.644l3.005-3.006a3.982 3.982 0 0 1 3.395-1.126 3.987 3.987 0 0 1 2.632 1.563 1 1 0 0 0 1.602-1.198z">
       </path>
      </svg>
     </a>
    </h1>
    <p>
     If you don't know about
     <a href="https://doc.traefik.io/traefik/">
      traefik
     </a>
     and you need a reverse-proxy then you might want to check it out.
I used to use nginx for my reverse proxy but the config was over my head, and once it was working I was afraid to touch it.
Traefik brings a lot to the table, my main uses are reverse proxy and ip whitelisting, but it's doing even more under the hood that I don't have a full-grasp of yet.
    </p>
    <p>
     I like Traefik a lot because once I get some basic config up it's incredibly easy to add services into my homelab whether they run on my primary server or not.
This will not be exhaustive but I'll outline my simple setup process of traefik and how I add services whether they are in docker or not.
    </p>
    <h1 id="docker">
     Docker
     <a alt="id" class="heading-permalink" href="#docker" title="link to #docker">
      <span class="visually-hidden">
      </span>
      <svg aria-hidden="true" fill="currentColor" focusable="false" height="1em" viewbox="0 0 24 24" width="1em" xmlns="http://www.w3.org/2000/svg">
       <path d="M9.199 13.599a5.99 5.99 0 0 0 3.949 2.345 5.987 5.987 0 0 0 5.105-1.702l2.995-2.994a5.992 5.992 0 0 0 1.695-4.285 5.976 5.976 0 0 0-1.831-4.211 5.99 5.99 0 0 0-6.431-1.242 6.003 6.003 0 0 0-1.905 1.24l-1.731 1.721a.999.999 0 1 0 1.41 1.418l1.709-1.699a3.985 3.985 0 0 1 2.761-1.123 3.975 3.975 0 0 1 2.799 1.122 3.997 3.997 0 0 1 .111 5.644l-3.005 3.006a3.982 3.982 0 0 1-3.395 1.126 3.987 3.987 0 0 1-2.632-1.563A1 1 0 0 0 9.201 13.6zm5.602-3.198a5.99 5.99 0 0 0-3.949-2.345 5.987 5.987 0 0 0-5.105 1.702l-2.995 2.994a5.992 5.992 0 0 0-1.695 4.285 5.976 5.976 0 0 0 1.831 4.211 5.99 5.99 0 0 0 6.431 1.242 6.003 6.003 0 0 0 1.905-1.24l1.723-1.723a.999.999 0 1 0-1.414-1.414L9.836 19.81a3.985 3.985 0 0 1-2.761 1.123 3.975 3.975 0 0 1-2.799-1.122 3.997 3.997 0 0 1-.111-5.644l3.005-3.006a3.982 3.982 0 0 1 3.395-1.126 3.987 3.987 0 0 1 2.632 1.563 1 1 0 0 0 1.602-1.198z">
       </path>
      </svg>
     </a>
    </h1>
    <p>
     In 2022 I'm still a docker fan-boy and I run my traefik instance in a docker container. 
This isn't necessary but I love the portability since my homelab is very dynamic at the moment.
And even if it wasn't I'd still want to keep traefik in docker because deployment and updating are just so flipping easy
    </p>
    <p>
     A simple docker-compose file for traefik might look like this:
    </p>
    <div class="highlight">
     <pre><span></span><code><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">traefik</span><span class="w"></span>
<span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="s">"traefik:v2.4"</span><span class="w"></span>
<span class="nt">network_mode</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">host</span><span class="w"></span>
<span class="nt">volumes</span><span class="p">:</span><span class="w"></span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">"docker-data/traefik/traefik.toml:/etc/traefik/traefik.toml:ro"</span><span class="w"></span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">"docker-data/traefik/config.yml:/etc/traefik/config.yml:ro"</span><span class="w"></span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">"docker-data/traefik/letsencrypt:/letsencrypt:rw"</span><span class="w"></span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">"/var/run/docker.sock:/var/run/docker.sock:ro"</span><span class="w">  </span><span class="c1"># for auto-discovery</span><span class="w"></span>
<span class="nt">env</span><span class="p">:</span><span class="w"> </span><span class="s">""</span><span class="w"></span>
<span class="nt">restart_policy</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">unless-stopped</span><span class="w"></span>
<span class="nt">memory</span><span class="p">:</span><span class="w"> </span><span class="s">"1g"</span><span class="w"></span>
</code></pre>
    </div>
    <h1 id="ansible-deployment">
     Ansible deployment
     <a alt="id" class="heading-permalink" href="#ansible-deployment" title="link to #ansible-deployment">
      <span class="visually-hidden">
      </span>
      <svg aria-hidden="true" fill="currentColor" focusable="false" height="1em" viewbox="0 0 24 24" width="1em" xmlns="http://www.w3.org/2000/svg">
       <path d="M9.199 13.599a5.99 5.99 0 0 0 3.949 2.345 5.987 5.987 0 0 0 5.105-1.702l2.995-2.994a5.992 5.992 0 0 0 1.695-4.285 5.976 5.976 0 0 0-1.831-4.211 5.99 5.99 0 0 0-6.431-1.242 6.003 6.003 0 0 0-1.905 1.24l-1.731 1.721a.999.999 0 1 0 1.41 1.418l1.709-1.699a3.985 3.985 0 0 1 2.761-1.123 3.975 3.975 0 0 1 2.799 1.122 3.997 3.997 0 0 1 .111 5.644l-3.005 3.006a3.982 3.982 0 0 1-3.395 1.126 3.987 3.987 0 0 1-2.632-1.563A1 1 0 0 0 9.201 13.6zm5.602-3.198a5.99 5.99 0 0 0-3.949-2.345 5.987 5.987 0 0 0-5.105 1.702l-2.995 2.994a5.992 5.992 0 0 0-1.695 4.285 5.976 5.976 0 0 0 1.831 4.211 5.99 5.99 0 0 0 6.431 1.242 6.003 6.003 0 0 0 1.905-1.24l1.723-1.723a.999.999 0 1 0-1.414-1.414L9.836 19.81a3.985 3.985 0 0 1-2.761 1.123 3.975 3.975 0 0 1-2.799-1.122 3.997 3.997 0 0 1-.111-5.644l3.005-3.006a3.982 3.982 0 0 1 3.395-1.126 3.987 3.987 0 0 1 2.632 1.563 1 1 0 0 0 1.602-1.198z">
       </path>
      </svg>
     </a>
    </h1>
    <p>
     <strong>
      I plan to have more on my homelab and Ansible on this site eventually...
     </strong>
    </p>
    <p>
     I use Ansible to deploy most of my services at home, including traefik. My main homelab repo is
     <a href="https://github.com/nicpayne713/ansible-nas">
      here
     </a>
     which is a fork of
     <a href="https://github.com/davestephens/ansible-nas">
      Ansible NAS
     </a>
     .
    </p>
    <blockquote>
     <p>
      If you want my stuff then be sure to go to the
      <code>
       user/nic
      </code>
      branch on my fork
     </p>
    </blockquote>
    <p>
     You can see the ansible stuff for traefik
     <a href="https://github.com/davestephens/ansible-nas/tree/master/roles/traefik">
      here
     </a>
    </p>
    <h1 id="config">
     Config
     <a alt="id" class="heading-permalink" href="#config" title="link to #config">
      <span class="visually-hidden">
      </span>
      <svg aria-hidden="true" fill="currentColor" focusable="false" height="1em" viewbox="0 0 24 24" width="1em" xmlns="http://www.w3.org/2000/svg">
       <path d="M9.199 13.599a5.99 5.99 0 0 0 3.949 2.345 5.987 5.987 0 0 0 5.105-1.702l2.995-2.994a5.992 5.992 0 0 0 1.695-4.285 5.976 5.976 0 0 0-1.831-4.211 5.99 5.99 0 0 0-6.431-1.242 6.003 6.003 0 0 0-1.905 1.24l-1.731 1.721a.999.999 0 1 0 1.41 1.418l1.709-1.699a3.985 3.985 0 0 1 2.761-1.123 3.975 3.975 0 0 1 2.799 1.122 3.997 3.997 0 0 1 .111 5.644l-3.005 3.006a3.982 3.982 0 0 1-3.395 1.126 3.987 3.987 0 0 1-2.632-1.563A1 1 0 0 0 9.201 13.6zm5.602-3.198a5.99 5.99 0 0 0-3.949-2.345 5.987 5.987 0 0 0-5.105 1.702l-2.995 2.994a5.992 5.992 0 0 0-1.695 4.285 5.976 5.976 0 0 0 1.831 4.211 5.99 5.99 0 0 0 6.431 1.242 6.003 6.003 0 0 0 1.905-1.24l1.723-1.723a.999.999 0 1 0-1.414-1.414L9.836 19.81a3.985 3.985 0 0 1-2.761 1.123 3.975 3.975 0 0 1-2.799-1.122 3.997 3.997 0 0 1-.111-5.644l3.005-3.006a3.982 3.982 0 0 1 3.395-1.126 3.987 3.987 0 0 1 2.632 1.563 1 1 0 0 0 1.602-1.198z">
       </path>
      </svg>
     </a>
    </h1>
    <p>
     I use a
     <code>
      traefik.toml
     </code>
     as the main config and it looks something like this.
With ansible a lot of this is done through template variables but this is the general idea.
This config tells traefik what ports to listen and forward on, and gives the names to be referenced by docker labels (down below).
    </p>
    <p>
     Traefik also has a handy web ui that with this config you can find on port
     <code>
      8080
     </code>
     .
There is a
     <code>
      providers
     </code>
     section - which is one of the biggest selling points of traefik for me.
I have a docker provider configured  and a static file.
    </p>
    <p>
     The docker provider lets traefik auto-discover new services that I deploy and automatically handle the routing!
The static file lets me easily add non-dockerized service routing, or routing to dockerized services on another host (I think traefik has an easier way to do this automatically but I don't do it often enough to need that kind of automation).
Then at the bottom is the SSL cert stuff. 
Using Let's Encrypt is pretty easy and I use Cloudflare as my DNS provider
    </p>
    <div class="highlight">
     <pre><span></span><code><span class="k">[entryPoints]</span><span class="w"></span>
<span class="k">[entryPoints.web]</span><span class="w"></span>
<span class="n">address</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">":80"</span><span class="w"></span>

<span class="k">[entryPoints.web.http.redirections.entryPoint]</span><span class="w"></span>
<span class="n">to</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">"websecure"</span><span class="w"></span>

<span class="k">[entryPoints.websecure]</span><span class="w"></span>
<span class="n">address</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">":443"</span><span class="w"></span>

<span class="k">[entryPoints.websecure.http.tls]</span><span class="w"></span>
<span class="n">certResolver</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">"letsencrypt"</span><span class="w"></span>

<span class="k">[entryPoints.websecure.http.tls.domains]</span><span class="w"></span>
<span class="n">main</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">"example.com"</span><span class="w"></span>
<span class="n">sans</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="w"></span>
<span class="s">"*.example.com"</span><span class="w"></span>
<span class="p">]</span><span class="w"></span>

<span class="k">[entryPoints.traefik]</span><span class="w"></span>
<span class="n">address</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">":8080"</span><span class="w"></span>

<span class="k">[providers]</span><span class="w"></span>
<span class="n">providersThrottleDuration</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">"1s"</span><span class="w"></span>
<span class="k">[providers.docker]</span><span class="w"></span>
<span class="n">exposedbydefault</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span><span class="w"></span>
<span class="k">[providers.file]</span><span class="w"></span>
<span class="n">filename</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">"/etc/traefik/config.yml"</span><span class="w"></span>

<span class="k">[api]</span><span class="w"></span>
<span class="n">insecure</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="w"></span>
<span class="n">dashboard</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="w"></span>

<span class="k">[log]</span><span class="w"></span>
<span class="n">level</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">"INFO"</span><span class="w"></span>

<span class="k">[ping]</span><span class="w"></span>
<span class="n">terminatingStatusCode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="w"></span>

<span class="k">[certificatesResolvers]</span><span class="w"></span>
<span class="k">[certificatesResolvers.letsencrypt]</span><span class="w"></span>
<span class="k">[certificatesResolvers.letsencrypt.acme]</span><span class="w"></span>
<span class="n">email</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">"my_email@example.com"</span><span class="w"></span>
<span class="n">storage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">"/letsencrypt/acme.json"</span><span class="w"></span>
<span class="n">caserver</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">"https://acme-staging-v02.api.letsencrypt.org/directory"</span><span class="w">  </span><span class="c1"># le staging, not prod</span><span class="w"></span>

<span class="k">[certificatesResolvers.letsencrypt.acme.dnsChallenge]</span><span class="w"></span>
<span class="n">provider</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">"cloudflare"</span><span class="w"></span>
</code></pre>
    </div>
    <h1 id="providersfile">
     Providers.file
     <a alt="id" class="heading-permalink" href="#providersfile" title="link to #providersfile">
      <span class="visually-hidden">
      </span>
      <svg aria-hidden="true" fill="currentColor" focusable="false" height="1em" viewbox="0 0 24 24" width="1em" xmlns="http://www.w3.org/2000/svg">
       <path d="M9.199 13.599a5.99 5.99 0 0 0 3.949 2.345 5.987 5.987 0 0 0 5.105-1.702l2.995-2.994a5.992 5.992 0 0 0 1.695-4.285 5.976 5.976 0 0 0-1.831-4.211 5.99 5.99 0 0 0-6.431-1.242 6.003 6.003 0 0 0-1.905 1.24l-1.731 1.721a.999.999 0 1 0 1.41 1.418l1.709-1.699a3.985 3.985 0 0 1 2.761-1.123 3.975 3.975 0 0 1 2.799 1.122 3.997 3.997 0 0 1 .111 5.644l-3.005 3.006a3.982 3.982 0 0 1-3.395 1.126 3.987 3.987 0 0 1-2.632-1.563A1 1 0 0 0 9.201 13.6zm5.602-3.198a5.99 5.99 0 0 0-3.949-2.345 5.987 5.987 0 0 0-5.105 1.702l-2.995 2.994a5.992 5.992 0 0 0-1.695 4.285 5.976 5.976 0 0 0 1.831 4.211 5.99 5.99 0 0 0 6.431 1.242 6.003 6.003 0 0 0 1.905-1.24l1.723-1.723a.999.999 0 1 0-1.414-1.414L9.836 19.81a3.985 3.985 0 0 1-2.761 1.123 3.975 3.975 0 0 1-2.799-1.122 3.997 3.997 0 0 1-.111-5.644l3.005-3.006a3.982 3.982 0 0 1 3.395-1.126 3.987 3.987 0 0 1 2.632 1.563 1 1 0 0 0 1.602-1.198z">
       </path>
      </svg>
     </a>
    </h1>
    <p>
     To my knowledge there isn't much to configure on the docker provider side of things until you deploy a service.
But the provider config file should get a little screen time here.
    </p>
    <p>
     The file defines a traefik http router for each service you define, in this case just
     <code>
      pihole
     </code>
     .
    </p>
    <p>
     Here I am adding my pihole instance which is not run inside docker but is inside a VM on another host.
I want the
     <code>
      entryPoints
     </code>
     to be set to
     <code>
      websecure
     </code>
     which is configured above in the http redirects.
I want some middlewares,
     <code>
      addprefix-pihole
     </code>
     and
     <code>
      default-headers
     </code>
     , which I'll explain below.
I set letsencrypt as the cert certResolver.
Finally I name the service
     <code>
      pihole
     </code>
     .
    </p>
    <p>
     Then in the
     <code>
      services
     </code>
     section I configure where pihole is located by just giving the internal IP for traefik to route to.
Finally I define my middlewares. 
To get to the pihole homepage you need to use the route
     <code>
      /admin
     </code>
     so I want that added automatically when I go to
     <code>
      pihole.example.com
     </code>
     so I come to
     <code>
      pihole.example.com/admin
     </code>
     .
And I wanted to restrict access to just my internal network and my wireguard network - this is done with the
     <code>
      default-whitelist
     </code>
     . 
The last thing is to configure a chain of middlewares that I called
     <code>
      secured
     </code>
     which is just easier for the docker labels later on.
    </p>
    <p>
     With this config in play though, traefik will know about the route
     <code>
      pihole.example.com
     </code>
     and handle the ip whitelisting and load balancing for me.
    </p>
    <div class="highlight">
     <pre><span></span><code><span class="nt">http</span><span class="p">:</span><span class="w"></span>
<span class="w"> </span><span class="c1">#region routers </span><span class="w"></span>
<span class="w">  </span><span class="nt">routers</span><span class="p">:</span><span class="w"></span>
<span class="w">    </span><span class="nt">pihole</span><span class="p">:</span><span class="w"></span>
<span class="w">      </span><span class="nt">entryPoints</span><span class="p">:</span><span class="w"></span>
<span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">"websecure"</span><span class="w"></span>
<span class="w">      </span><span class="nt">rule</span><span class="p">:</span><span class="w"> </span><span class="s">"Host(`pihole.example.com`)"</span><span class="w"></span>
<span class="w">      </span><span class="nt">middlewares</span><span class="p">:</span><span class="w"></span>
<span class="w">        </span><span class="c1"># - default-headers</span><span class="w"></span>
<span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">addprefix-pihole</span><span class="w"></span>
<span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">default-whitelist</span><span class="w"></span>
<span class="w">      </span><span class="nt">tls</span><span class="p">:</span><span class="w"> </span>
<span class="w">        </span><span class="nt">certResolver</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">letsencrypt</span><span class="w"></span>
<span class="w">      </span><span class="nt">service</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">pihole</span><span class="w"></span>
<span class="w">  </span><span class="c1">#region services</span><span class="w"></span>
<span class="w">  </span><span class="nt">services</span><span class="p">:</span><span class="w"></span>
<span class="w">    </span><span class="nt">pihole</span><span class="p">:</span><span class="w"></span>
<span class="w">      </span><span class="nt">loadBalancer</span><span class="p">:</span><span class="w"></span>
<span class="w">        </span><span class="nt">servers</span><span class="p">:</span><span class="w"></span>
<span class="w">          </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">url</span><span class="p">:</span><span class="w"> </span><span class="s">"http://192.168.1.3:80"</span><span class="w"></span>
<span class="w">        </span><span class="nt">passHostHeader</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span><span class="w"></span>
<span class="w">  </span><span class="c1">#endregion</span><span class="w"></span>
<span class="w">  </span><span class="nt">middlewares</span><span class="p">:</span><span class="w"></span>
<span class="w">    </span><span class="nt">addprefix-pihole</span><span class="p">:</span><span class="w"></span>
<span class="w">      </span><span class="nt">addPrefix</span><span class="p">:</span><span class="w"></span>
<span class="w">        </span><span class="nt">prefix</span><span class="p">:</span><span class="w"> </span><span class="s">"/admin"</span><span class="w"></span>
<span class="w">    </span><span class="nt">https-redirect</span><span class="p">:</span><span class="w"></span>
<span class="w">      </span><span class="nt">redirectScheme</span><span class="p">:</span><span class="w"></span>
<span class="w">        </span><span class="nt">scheme</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">https</span><span class="w"></span>

<span class="w">    </span><span class="nt">default-headers</span><span class="p">:</span><span class="w"></span>
<span class="w">      </span><span class="nt">headers</span><span class="p">:</span><span class="w"></span>
<span class="w">        </span><span class="nt">frameDeny</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span><span class="w"></span>
<span class="w">        </span><span class="nt">sslRedirect</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span><span class="w"></span>
<span class="w">        </span><span class="nt">browserXssFilter</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span><span class="w"></span>
<span class="w">        </span><span class="nt">contentTypeNosniff</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span><span class="w"></span>
<span class="w">        </span><span class="nt">forceSTSHeader</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span><span class="w"></span>
<span class="w">        </span><span class="nt">stsIncludeSubdomains</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span><span class="w"></span>
<span class="w">        </span><span class="nt">stsPreload</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span><span class="w"></span>
<span class="w">        </span><span class="nt">stsSeconds</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">15552000</span><span class="w"></span>
<span class="w">        </span><span class="nt">customFrameOptionsValue</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">SAMEORIGIN</span><span class="w"></span>

<span class="w">    </span><span class="nt">default-whitelist</span><span class="p">:</span><span class="w"></span>
<span class="w">      </span><span class="nt">ipWhiteList</span><span class="p">:</span><span class="w"></span>
<span class="w">        </span><span class="nt">sourceRange</span><span class="p">:</span><span class="w"></span>
<span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">"10.6.0.0/24"</span><span class="w">  </span><span class="c1"># wg</span><span class="w"></span>
<span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">"192.168.1.0/24"</span><span class="w">  </span><span class="c1"># lan</span><span class="w"></span>
<span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">"172.17.0.0/16"</span><span class="w">  </span><span class="c1"># docker</span><span class="w"></span>

<span class="w">    </span><span class="nt">secured</span><span class="p">:</span><span class="w"></span>
<span class="w">      </span><span class="nt">chain</span><span class="p">:</span><span class="w"></span>
<span class="w">        </span><span class="nt">middlewares</span><span class="p">:</span><span class="w"></span>
<span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">default-whitelist</span><span class="w"></span>
<span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">default-headers</span><span class="w"></span>
</code></pre>
    </div>
    <h1 id="docker-labels">
     Docker labels
     <a alt="id" class="heading-permalink" href="#docker-labels" title="link to #docker-labels">
      <span class="visually-hidden">
      </span>
      <svg aria-hidden="true" fill="currentColor" focusable="false" height="1em" viewbox="0 0 24 24" width="1em" xmlns="http://www.w3.org/2000/svg">
       <path d="M9.199 13.599a5.99 5.99 0 0 0 3.949 2.345 5.987 5.987 0 0 0 5.105-1.702l2.995-2.994a5.992 5.992 0 0 0 1.695-4.285 5.976 5.976 0 0 0-1.831-4.211 5.99 5.99 0 0 0-6.431-1.242 6.003 6.003 0 0 0-1.905 1.24l-1.731 1.721a.999.999 0 1 0 1.41 1.418l1.709-1.699a3.985 3.985 0 0 1 2.761-1.123 3.975 3.975 0 0 1 2.799 1.122 3.997 3.997 0 0 1 .111 5.644l-3.005 3.006a3.982 3.982 0 0 1-3.395 1.126 3.987 3.987 0 0 1-2.632-1.563A1 1 0 0 0 9.201 13.6zm5.602-3.198a5.99 5.99 0 0 0-3.949-2.345 5.987 5.987 0 0 0-5.105 1.702l-2.995 2.994a5.992 5.992 0 0 0-1.695 4.285 5.976 5.976 0 0 0 1.831 4.211 5.99 5.99 0 0 0 6.431 1.242 6.003 6.003 0 0 0 1.905-1.24l1.723-1.723a.999.999 0 1 0-1.414-1.414L9.836 19.81a3.985 3.985 0 0 1-2.761 1.123 3.975 3.975 0 0 1-2.799-1.122 3.997 3.997 0 0 1-.111-5.644l3.005-3.006a3.982 3.982 0 0 1 3.395-1.126 3.987 3.987 0 0 1 2.632 1.563 1 1 0 0 0 1.602-1.198z">
       </path>
      </svg>
     </a>
    </h1>
    <p>
     Now the real magic is with Docker.
Here is an example docker-compose file for spinning up a
     <a href="https://jellyfin.org/">
      jellyfin
     </a>
     server that you want to expose to the world, or at least access at home with
     <code>
      jellyfin.example.com
     </code>
     instead of
     <code>
      http://192.168.1.N:8096
     </code>
     ...
    </p>
    <p>
     I left some of the ansible variable stuff in here, but the main part to be concerned with is the
     <code>
      labels
     </code>
     section...
    </p>
    <p>
     We define just a few labels to throw onto this docker container which let's traefik discover it automatically and apply any settings necessary (like my
     <code>
      ipWhiteList
     </code>
     ).
    </p>
    <ul>
     <li>
      <code>
       traefik.enable
      </code>
      is either True or False.
     </li>
     <li>
      <code>
       traefik.http.router.jellyfin.rule
      </code>
      defines an http router called jellyfin and sets the url to
      <code>
       jellyfin.example.com
      </code>
      (if example.com was my
      <code>
       ansible_nas_domain
      </code>
      )
     </li>
     <li>
      <code>
       traefik.http.routers.jellyfin.tls.certresolver
      </code>
      is set to letsencrypt since I use LE for my wildcard certs.
     </li>
     <li>
      <code>
       traefik.http.routers.jellyfin.tls.domains[0].main
      </code>
      will just be
      <code>
       example.com
      </code>
      -&gt; and this should remind you of the toml file above
     </li>
     <li>
      <code>
       traefik.http.routers.jellyfin.tls.domains[0].sans
      </code>
      is set to
      <code>
       *.example.com
      </code>
     </li>
     <li>
      <code>
       traefik.http.services.jellyfin.loadbalancer.server.port
      </code>
      is set to jellyfin's default http port of 8096, which tells traefik which port to point to for this service.
     </li>
    </ul>
    <div class="highlight">
     <pre><span></span><code><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">jellyfin</span><span class="w"></span>
<span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">linuxserver/jellyfin</span><span class="w"></span>
<span class="nt">volumes</span><span class="p">:</span><span class="w"></span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">":/config:rw"</span><span class="w"></span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">":/movies:"</span><span class="w"></span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">":/music:"</span><span class="w"></span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">":/photos:"</span><span class="w"></span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">":/tv:"</span><span class="w"></span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">":/books:"</span><span class="w"></span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">":/audiobooks:"</span><span class="w"></span>
<span class="nt">ports</span><span class="p">:</span><span class="w"></span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">":8096"</span><span class="w"></span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">":8920"</span><span class="w"></span>
<span class="nt">env</span><span class="p">:</span><span class="w"></span>
<span class="w">  </span><span class="nt">TZ</span><span class="p">:</span><span class="w"> </span><span class="s">""</span><span class="w"></span>
<span class="w">  </span><span class="nt">PUID</span><span class="p">:</span><span class="w"> </span><span class="s">""</span><span class="w"></span>
<span class="w">  </span><span class="nt">PGID</span><span class="p">:</span><span class="w"> </span><span class="s">""</span><span class="w"></span>
<span class="nt">restart_policy</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">unless-stopped</span><span class="w"></span>
<span class="nt">memory</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">1g</span><span class="w"></span>
<span class="nt">labels</span><span class="p">:</span><span class="w"></span>
<span class="w">  </span><span class="nt">traefik.enable</span><span class="p">:</span><span class="w"> </span><span class="s">""</span><span class="w"></span>
<span class="w">  </span><span class="nt">traefik.http.routers.jellyfin.rule</span><span class="p">:</span><span class="w"> </span><span class="s">"Host(`jellyfin.`)"</span><span class="w"></span>
<span class="w">  </span><span class="nt">traefik.http.routers.jellyfin.tls.certresolver</span><span class="p">:</span><span class="w"> </span><span class="s">"letsencrypt"</span><span class="w"></span>
<span class="w">  </span><span class="l l-Scalar l-Scalar-Plain">traefik.http.routers.jellyfin.tls.domains[0].main</span><span class="p p-Indicator">:</span><span class="w"> </span><span class="s">""</span><span class="w"></span>
<span class="w">  </span><span class="l l-Scalar l-Scalar-Plain">traefik.http.routers.jellyfin.tls.domains[0].sans</span><span class="p p-Indicator">:</span><span class="w"> </span><span class="s">"*."</span><span class="w"></span>
<span class="w">  </span><span class="nt">traefik.http.services.jellyfin.loadbalancer.server.port</span><span class="p">:</span><span class="w"> </span><span class="s">"8096"</span><span class="w"></span>
</code></pre>
    </div>
    <p>
     And just like that traefik will automagically find your jellyfin container and route
     <code>
      jellyfin.example.com
     </code>
     to it!
    </p>
   </div>
   <hr/>
   <div id="show">
   </div>
  </article>
  <footer>
   <ul class="social">
    <li>
     <a href="https://twitter.com/pypeaday">
      twitter
     </a>
    </li>
    <li>
     <a href="https://www.linkedin.com/in/nicpayne713/">
      LinkedIn
     </a>
    </li>
    <li>
     <a href="https://github.com/nicpayne713">
      GitHub
     </a>
    </li>
    <li>
     <a href="https://www.twitch.tv/pypeaday">
      twitch
     </a>
    </li>
   </ul>
   <p>
    © 2022 - 2022
   </p>
  </footer>
 </body>
</html>